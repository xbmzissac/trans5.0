<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊâπÈáèÁøªËØëÂ∑•ÂÖ∑</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #667eea;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
        }

        .section h2::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            margin-right: 10px;
        }

        .file-upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            margin-bottom: 15px;
        }

        .file-upload-area:hover {
            border-color: #764ba2;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            transform: translateY(-2px);
        }

        .file-upload-area.dragover {
            border-color: #764ba2;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
        }

        input[type="file"] {
            display: none;
        }

        .upload-label {
            cursor: pointer;
            display: inline-block;
            padding: 12px 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 25px;
            transition: all 0.3s ease;
            font-weight: 600;
            margin: 10px;
        }

        .upload-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .api-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .api-group {
            padding: 20px;
            background: #f8f9ff;
            border-radius: 12px;
            border: 2px solid #e0e6ff;
        }

        .api-group h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }

        input[type="text"], input[type="url"], select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e6ff;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        input[type="text"]:focus, input[type="url"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .translate-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .translate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }

        .translate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e6ff;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .results {
            margin-top: 30px;
        }

        .file-result {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #667eea;
        }

        .file-result h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .translation-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .content-block {
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        .content-block h4 {
            margin-bottom: 10px;
            color: #495057;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .content-text {
            white-space: pre-wrap;
            line-height: 1.6;
            color: #333;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
        }

        .download-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .status {
            padding: 10px 20px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .file-list {
            background: #f8f9ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e0e6ff;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            .api-config {
                grid-template-columns: 1fr;
            }
            
            .translation-content {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåê ÊâπÈáèÁøªËØëÂ∑•ÂÖ∑</h1>
        
        <!-- Êñá‰ª∂‰∏ä‰º†Âå∫Âüü -->
        <div class="section">
            <h2>üìÅ Êñá‰ª∂‰∏ä‰º†</h2>
            
            <div class="file-upload-area" id="txtUploadArea">
                <p>ÊãñÊãΩTXTÊñá‰ª∂Âà∞Ê≠§Â§ÑÊàñÁÇπÂáªÈÄâÊã©</p>
                <label for="txtFiles" class="upload-label">ÈÄâÊã©TXTÊñá‰ª∂</label>
                <input type="file" id="txtFiles" multiple accept=".txt" />
            </div>
            <div id="txtFileList" class="file-list" style="display: none;"></div>
            
            <div class="file-upload-area" id="excelUploadArea">
                <p>‰∏ä‰º†ExcelÂØπÁÖßË°®ÔºàÂåÖÂê´ÂéüÊñáÂíåËØëÊñáÂàóÔºâ</p>
                <label for="excelFile" class="upload-label">ÈÄâÊã©ExcelÊñá‰ª∂</label>
                <input type="file" id="excelFile" accept=".xlsx,.xls" />
            </div>
            <div id="excelFileInfo" class="file-list" style="display: none;"></div>
        </div>

        <!-- APIÈÖçÁΩÆ -->
        <div class="section">
            <h2>üîß APIÈÖçÁΩÆ</h2>
            <div class="api-config">
                <div class="api-group">
                    <h3>Claude API</h3>
                    <div class="form-group">
                        <label for="claudeApiKey">APIÂØÜÈí•</label>
                        <input type="text" id="claudeApiKey" placeholder="sk-ant-..." />
                    </div>
                    <div class="form-group">
                        <label for="claudeModel">Ê®°Âûã</label>
                        <select id="claudeModel">
                            <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                            <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                            <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                        </select>
                    </div>
                </div>
                
                <div class="api-group">
                    <h3>GPT API</h3>
                    <div class="form-group">
                        <label for="gptApiKey">APIÂØÜÈí•</label>
                        <input type="text" id="gptApiKey" placeholder="sk-..." />
                    </div>
                    <div class="form-group">
                        <label for="gptModel">Ê®°Âûã</label>
                        <select id="gptModel">
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-4-turbo-preview">GPT-4 Turbo</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gptBaseUrl">Base URL (ÂèØÈÄâ)</label>
                        <input type="url" id="gptBaseUrl" placeholder="https://api.openai.com/v1" />
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="translateEngine">ÁøªËØëÂºïÊìé</label>
                <select id="translateEngine">
                    <option value="claude">Claude</option>
                    <option value="gpt">GPT</option>
	    <option value="both">Claude + GPT ÂèåÂºïÊìé</option>
                </select>
            </div>
        </div>

        <!-- ÁøªËØëÊéßÂà∂ -->
        <div class="section">
            <h2>üöÄ ÂºÄÂßãÁøªËØë</h2>
            <button class="translate-btn" id="startTranslation">ÂºÄÂßãÊâπÈáèÁøªËØë</button>
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="statusMsg"></div>
        </div>

        <!-- ÁøªËØëÁªìÊûú -->
        <div class="section results" id="resultsSection" style="display: none;">
            <h2>üìã ÁøªËØëÁªìÊûú</h2>
            <button class="download-btn" id="downloadZip">‰∏ãËΩΩZIPÊñá‰ª∂</button>
            <div id="translationResults"></div>
        </div>
    </div>

    <script>
        class BatchTranslator {
            constructor() {
                this.txtFiles = [];
                this.excelData = null;
                this.translationDict = {};
                this.results = [];
                this.initEventListeners();
            }

            initEventListeners() {
                // Êñá‰ª∂‰∏ä‰º†‰∫ã‰ª∂
                document.getElementById('txtFiles').addEventListener('change', (e) => {
                    this.handleTxtFiles(e.target.files);
                });

                document.getElementById('excelFile').addEventListener('change', (e) => {
                    this.handleExcelFile(e.target.files[0]);
                });

                // ÊãñÊãΩ‰∫ã‰ª∂
                const txtArea = document.getElementById('txtUploadArea');
                txtArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    txtArea.classList.add('dragover');
                });

                txtArea.addEventListener('dragleave', () => {
                    txtArea.classList.remove('dragover');
                });

                txtArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    txtArea.classList.remove('dragover');
                    this.handleTxtFiles(e.dataTransfer.files);
                });

                // ÁøªËØëÊåâÈíÆ
                document.getElementById('startTranslation').addEventListener('click', () => {
                    this.startTranslation();
                });

                // ‰∏ãËΩΩÊåâÈíÆ
                document.getElementById('downloadZip').addEventListener('click', () => {
                    this.downloadResults();
                });
            }

            handleTxtFiles(files) {
                this.txtFiles = Array.from(files).filter(file => file.type === 'text/plain' || file.name.endsWith('.txt'));
                this.displayTxtFiles();
            }

            displayTxtFiles() {
                const fileList = document.getElementById('txtFileList');
                if (this.txtFiles.length === 0) {
                    fileList.style.display = 'none';
                    return;
                }

                fileList.style.display = 'block';
                fileList.innerHTML = '<h4>Â∑≤ÈÄâÊã©ÁöÑTXTÊñá‰ª∂Ôºö</h4>';
                this.txtFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <span>${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                        <button onclick="translator.removeTxtFile(${index})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">Âà†Èô§</button>
                    `;
                    fileList.appendChild(fileItem);
                });
            }

            removeTxtFile(index) {
                this.txtFiles.splice(index, 1);
                this.displayTxtFiles();
            }

            async handleExcelFile(file) {
                if (!file) return;

                try {
                    const data = await this.readFile(file);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    this.excelData = jsonData;
                    this.buildTranslationDict();
                    this.displayExcelInfo(file.name, jsonData.length);
                } catch (error) {
                    this.showStatus('ExcelÊñá‰ª∂ËØªÂèñÂ§±Ë¥•: ' + error.message, 'error');
                }
            }

            buildTranslationDict() {
                this.translationDict = {};
                if (!this.excelData) return;

                // Ëá™Âä®Ê£ÄÊµãÂàóÂêç
                const firstRow = this.excelData[0];
                const columns = Object.keys(firstRow);
                
                // ÂØªÊâæÂèØËÉΩÁöÑÂéüÊñáÂíåËØëÊñáÂàó
                let sourceCol = null, targetCol = null;
                
                for (let col of columns) {
                    const lowerCol = col.toLowerCase();
                    if (lowerCol.includes('ÂéüÊñá') || lowerCol.includes('source') || lowerCol.includes('original')) {
                        sourceCol = col;
                    }
                    if (lowerCol.includes('ËØëÊñá') || lowerCol.includes('target') || lowerCol.includes('translation')) {
                        targetCol = col;
                    }
                }

                // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞Ôºå‰ΩøÁî®Ââç‰∏§Âàó
                if (!sourceCol || !targetCol) {
                    sourceCol = columns[0];
                    targetCol = columns[1];
                }

                // ÊûÑÂª∫ÁøªËØëÂ≠óÂÖ∏
                this.excelData.forEach(row => {
                    const source = row[sourceCol];
                    const target = row[targetCol];
                    if (source && target) {
                        this.translationDict[source.trim()] = target.trim();
                    }
                });

                this.showStatus(`Â∑≤Âä†ËΩΩ${Object.keys(this.translationDict).length}Êù°ÁøªËØëÂØπÁÖß`, 'success');
            }

            displayExcelInfo(filename, rowCount) {
                const excelInfo = document.getElementById('excelFileInfo');
                excelInfo.style.display = 'block';
                excelInfo.innerHTML = `
                    <h4>ExcelÊñá‰ª∂‰ø°ÊÅØÔºö</h4>
                    <div class="file-item">
                        <span>${filename}</span>
                        <span>${rowCount}Ë°åÊï∞ÊçÆ</span>
                    </div>
                `;
            }

            async readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(new Uint8Array(e.target.result));
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }

            async readTextFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsText(file, 'utf-8');
                });
            }

            async startTranslation() {
                if (this.txtFiles.length === 0) {
                    this.showStatus('ËØ∑ÂÖàÈÄâÊã©TXTÊñá‰ª∂', 'error');
                    return;
                }

                // ÊõøÊç¢ÂéüÊù•ÁöÑAPIÂØÜÈí•È™åËØÅÈÉ®ÂàÜ
	const engine = document.getElementById('translateEngine').value;
	let apiKeyValid = false;

	if (engine === 'claude') {
    	    apiKeyValid = document.getElementById('claudeApiKey').value.trim() !== '';
	} else if (engine === 'gpt') {
    	    apiKeyValid = document.getElementById('gptApiKey').value.trim() !== '';
	} else if (engine === 'both') {
	    const claudeKey = document.getElementById('claudeApiKey').value.trim();
	    const gptKey = document.getElementById('gptApiKey').value.trim();
	    apiKeyValid = claudeKey !== '' && gptKey !== '';
	}

	if (!apiKeyValid) {
	    this.showStatus('ËØ∑ËæìÂÖ•Áõ∏Â∫îÁöÑAPIÂØÜÈí•', 'error');
	    return;
	}

                this.showProgress(true);
                this.results = [];
                
                for (let i = 0; i < this.txtFiles.length; i++) {
                    const file = this.txtFiles[i];
                    this.updateProgress((i / this.txtFiles.length) * 100, `Ê≠£Âú®ÁøªËØë: ${file.name}`);
                    
                    try {
                        const content = await this.readTextFile(file);
                        const translatedContent = await this.translateText(content, engine);
                        
                        this.results.push({
                            filename: file.name,
                            original: content,
                            translated: translatedContent
                        });
                        
                        this.showStatus(`‚úÖ ${file.name} ÁøªËØëÂÆåÊàê`, 'success');
                    } catch (error) {
                        this.showStatus(`‚ùå ${file.name} ÁøªËØëÂ§±Ë¥•: ${error.message}`, 'error');
                        this.results.push({
                            filename: file.name,
                            original: await this.readTextFile(file),
                            translated: 'ÁøªËØëÂ§±Ë¥•: ' + error.message
                        });
                    }
                }

                this.updateProgress(100, 'ÁøªËØëÂÆåÊàêÔºÅ');
                this.displayResults();
                this.showProgress(false);
            }

            async translateText(text, engine) {
	let translatedText;
    
    	// Ê†πÊçÆÂºïÊìéÈÄâÊã©ËøõË°åÁøªËØë
    	if (engine === 'claude') {
	        translatedText = await this.translateWithClaude(text);
	} else if (engine === 'gpt') {
	        translatedText = await this.translateWithGPT(text);
	} else if (engine === 'both') {
        	// ÂèåAPIÂêåÊó∂ÁøªËØë
	        const [claudeResult, gptResult] = await Promise.allSettled([
	            this.translateWithClaude(text),
	            this.translateWithGPT(text)
	        ]);
        
	        // Â§ÑÁêÜÁøªËØëÁªìÊûú
	        let claudeTranslation = '';
	        let gptTranslation = '';
        
	        if (claudeResult.status === 'fulfilled') {
	            claudeTranslation = claudeResult.value;
	        } else {
	            claudeTranslation = `ClaudeÁøªËØëÂ§±Ë¥•: ${claudeResult.reason.message}`;
	        }
        
	        if (gptResult.status === 'fulfilled') {
	            gptTranslation = gptResult.value;
	        } else {
	            gptTranslation = `GPTÁøªËØëÂ§±Ë¥•: ${gptResult.reason.message}`;
	        }
        
	        // ÂêàÂπ∂‰∏§‰∏™ÁøªËØëÁªìÊûú
	        translatedText = `=== ClaudeÁøªËØë ===\n${claudeTranslation}\n\n=== GPTÁøªËØë ===\n${gptTranslation}`;
	    } else {
	        throw new Error('Êú™Áü•ÁöÑÁøªËØëÂºïÊìé');
	    }
    
	    // ÁÑ∂ÂêéÂú®APIÁøªËØëÁªìÊûúÂü∫Á°Ä‰∏äÂ∫îÁî®ExcelÂØπÁÖßË°®ËøõË°åÂêéÂ§ÑÁêÜ
	    if (Object.keys(this.translationDict).length > 0) {
	        translatedText = this.applyDictionaryTranslation(translatedText);
	    }
    
	    return translatedText;
            }

// ÂêåÊó∂ÈúÄË¶ÅÊõ¥Êñ∞HTML‰∏≠ÁöÑÁøªËØëÂºïÊìéÈÄâÊã©Âô®
// Âú®HTMLÁöÑselectÈÄâÈ°π‰∏≠Ê∑ªÂä†Ôºö
// <option value="both">Claude + GPT ÂèåÂºïÊìé</option>

                // Âê¶Âàô‰ΩøÁî®APIÁøªËØë
                if (engine === 'claude') {
                    return await this.translateWithClaude(text);
                } else {
                    return await this.translateWithGPT(text);
                }
            }

            applyDictionaryTranslation(text) {
                if (Object.keys(this.translationDict).length === 0) {
                    return text;
                }

                let translatedText = text;
                
                // ÊåâÈïøÂ∫¶ÊéíÂ∫èÔºå‰ºòÂÖàÊõøÊç¢ÈïøÁü≠ËØ≠
                const sortedKeys = Object.keys(this.translationDict).sort((a, b) => b.length - a.length);
                
                for (let source of sortedKeys) {
                    const target = this.translationDict[source];
                    // ‰ΩøÁî®ÂÖ®Â±ÄÊõøÊç¢
                    translatedText = translatedText.split(source).join(target);
                }

                return translatedText;
            }

            async translateWithClaude(text) {
                const apiKey = document.getElementById('claudeApiKey').value;
                const model = document.getElementById('claudeModel').value;

                const prompt = this.buildTranslationPrompt(text);

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: model,
                        max_tokens: 4000,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Claude APIÈîôËØØ: ${response.status}`);
                }

                const data = await response.json();
                return data.content[0].text;
            }

            async translateWithGPT(text) {
                const apiKey = document.getElementById('gptApiKey').value;
                const model = document.getElementById('gptModel').value;
                const baseUrl = document.getElementById('gptBaseUrl').value || 'https://api.openai.com/v1';

                const prompt = this.buildTranslationPrompt(text);

                const response = await fetch(`${baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }],
                        max_tokens: 4000,
                        temperature: 0.3
                    })
                });

                if (!response.ok) {
                    throw new Error(`GPT APIÈîôËØØ: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            }

            buildTranslationPrompt(text) {
                let prompt = "‰Ω†ÊòØ‰∏Ä‰∏™‰∏≠ÈòøÁü≠Âè•Â≠óÂπïÁøªËØëÔºåËØ∑Áî®Ê†áÂáÜÂú∞ÈÅìÁöÑÈòøÊãâ‰ºØËØ≠Ê†áÂáÜËØ≠Â∞Ü‰∏ãÈù¢ÁöÑ‰∏≠ÊñáÂè∞ËØçÁøªËØë‰∏∫ÈòøÊãâ‰ºØËØ≠ÔºåÁ°Æ‰øù‰πãÂêéÁöÑÁøªËØëÈÉΩÈÅµ‰ªé‰ª•‰∏ãÁøªËØëÂéüÂàôÔºö1.ËØ≠Ê≥ïÂáÜÁ°ÆÔºå‰∏çÂæóÈöèÊÑèÂ¢ûÂä†ÊàñÂà†ÂáèÂéüÊñáÔºå‰∏çÂæóÂΩ±ÂìçÊïÖ‰∫ãÂâßÊÉÖÂèëÂ±ïÔºåË¶ÅÂÅöÂà∞‰ø°ËææÈõÖÔºö‰ø°ÔºöËßÑËåÉÁî®ËØçÔºåÊ≠£Á°ÆÁøªËØëÂéüÊñáÁöÑÊÑèÊÄùÔºå‰∏çÂæóÈîôËØë„ÄÅÊºèËØë„ÄÅÂ¢ûËØëÔºõËææÔºöË°®ËææÁöÑÊÑèÊÄùË¶ÅÂà∞‰ΩçÔºå‰ΩÜÊòØ‰∏çÈúÄË¶ÅÂÆåÂÖ®ÈÄêÂ≠óÁøªËØëÔºõÈõÖÔºö‰∏∫‰∫ÜÈÄÇÂ∫îÂ§ñÂõΩËØªËÄÖÁöÑÈòÖËØª‰π†ÊÉØÔºåÂ∫îËØ•Ê†πÊçÆÈòøÊãâ‰ºØËØ≠ÁöÑË°®Ëææ‰π†ÊÉØÂíåÈÄªËæëÔºåÂØπÂéüÊñáËøõË°åÈÄÇÂΩìÁöÑË∞ÉÊï¥Ôºå‰ª•Á°Æ‰øùËØëÊñáÁöÑÂèØËØªÊÄßÂíåÊµÅÁïÖÊÄßÔºå2.ËØëÊñá‰∏≠ÈòøÊãâ‰ºØËØ≠‰∏çË¶ÅÊ∑ªÂä†‰ªª‰ΩïÊ†áÈü≥Á¨¶Âè∑„ÄÇËØ∑Â∞ÜËøôÊÆµËØùÊõ¥Êñ∞Âà∞ÊàëÁöÑËÆ∞ÂøÜÈáåÂπ∂Âú®‰ª•ÂêéÁøªËØëÈáåËøêÁî®„ÄÇ3.Áî®ËØçË¥¥ËøëÈòøÊãâ‰ºØËØ≠ÁîüÊ¥ªËØ≠Â¢ÉÔºå‰øóËØ≠‰øöËØ≠‰∏çÁõ¥ËØëÔºåÂ∞ΩÈáèÂú®ÈòøÊãâ‰ºØËØ≠‰∏≠ÂØªÊâæÂèØ‰ª•Ë°®ËææÁõ∏‰ººÊÑèÊÄùÁöÑÈòøÊãâ‰ºØËØ≠‰øóËØ≠Êù•Êõø‰ª£„ÄÇ4.Âè™ËæìÂá∫ËØëÊñáÔºå‰∏çË¶ÅÂåÖÂê´‰ªª‰ΩïËß£ÈáäÊàñÂéüÊñá„ÄÇÔºö\n\n" + text;
                if (Object.keys(this.translationDict).length > 0) {
                    prompt += "\n\n 1. ÂøÖÈ°ª‰ºòÂÖà‰ΩøÁî®‰ª•‰∏ãÊúØËØ≠Ë°®Ôºà‰∏çÂèØ‰øÆÊîπÔºâÔºö\n";
                    const examples = Object.entries(this.translationDict).slice(0, 10);
                    examples.forEach(([source, target]) => {
                        prompt += `${source} -> ${target}\n`;
                    });
                    prompt += "\nËØ∑‰ºòÂÖà‰ΩøÁî®‰∏äËø∞ÂØπÁÖßË°®‰∏≠ÁöÑÁøªËØë„ÄÇ";
                }

                return prompt;
            }

            showProgress(show) {
                const progressBar = document.getElementById('progressBar');
                progressBar.style.display = show ? 'block' : 'none';
                
                const button = document.getElementById('startTranslation');
                button.disabled = show;
                button.textContent = show ? 'ÁøªËØë‰∏≠...' : 'ÂºÄÂßãÊâπÈáèÁøªËØë';
            }

            updateProgress(percent, message) {
                const progressFill = document.getElementById('progressFill');
                progressFill.style.width = percent + '%';
                
                if (message) {
                    this.showStatus(message, 'info');
                }
            }

            showStatus(message, type) {
                const statusMsg = document.getElementById('statusMsg');
                statusMsg.innerHTML = `<div class="status ${type}">${message}</div>`;
            }

            displayResults() {
                const resultsSection = document.getElementById('resultsSection');
                const resultsContainer = document.getElementById('translationResults');
                
                resultsSection.style.display = 'block';
                resultsContainer.innerHTML = '';

                this.results.forEach((result, index) => {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'file-result';
                    resultDiv.innerHTML = `
                        <h3>
                            ${result.filename}
                            <button class="copy-btn" onclick="translator.copyToClipboard(${index})">Â§çÂà∂ËØëÊñá</button>
                        </h3>
                        <div class="translation-content">
                            <div class="content-block">
                                <h4>ÂéüÊñá</h4>
                                <div class="content-text">${result.original}</div>
                            </div>
                            <div class="content-block">
                                <h4>ËØëÊñá</h4>
                                <div class="content-text">${result.translated}</div>
                            </div>
                        </div>
                    `;
                    resultsContainer.appendChild(resultDiv);
                });
            }

            async copyToClipboard(index) {
                const result = this.results[index];
                try {
                    await navigator.clipboard.writeText(result.translated);
                    this.showStatus(`Â∑≤Â§çÂà∂ ${result.filename} ÁöÑËØëÊñáÂà∞Ââ™Ë¥¥Êùø`, 'success');
                } catch (error) {
                    // Â§áÁî®ÊñπÊ°à
                    const textArea = document.createElement('textarea');
                    textArea.value = result.translated;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    this.showStatus(`Â∑≤Â§çÂà∂ ${result.filename} ÁöÑËØëÊñáÂà∞Ââ™Ë¥¥Êùø`, 'success');
                }
            }

            async downloadResults() {
                if (this.results.length === 0) {
                    this.showStatus('Ê≤°ÊúâÁøªËØëÁªìÊûúÂèØ‰∏ãËΩΩ', 'error');
                    return;
                }

                const zip = new JSZip();
                
                this.results.forEach(result => {
                    const filename = result.filename.replace('.txt', '_translated.txt');
                    zip.file(filename, result.translated);
                });

                const content = await zip.generateAsync({ type: 'blob' });
const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = `translation_results_${new Date().toISOString().slice(0, 10)}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showStatus('ZIPÊñá‰ª∂‰∏ãËΩΩÂ∑≤ÂºÄÂßã', 'success');
            }
        }

        // ÂàùÂßãÂåñÁøªËØëÂô®
        const translator = new BatchTranslator();

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÁöÑÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºåÂàùÂßãÂåñÁøªËØëÂô®');
            
            // ÊµãËØïÊåâÈíÆÁÇπÂáª
            const translateBtn = document.getElementById('startTranslation');
            const txtFilesInput = document.getElementById('txtFiles');
            
            if (!translateBtn) {
                console.error('Êâæ‰∏çÂà∞ÁøªËØëÊåâÈíÆ');
            } else {
                console.log('ÁøªËØëÊåâÈíÆÊâæÂà∞');
            }
            
            if (!txtFilesInput) {
                console.error('Êâæ‰∏çÂà∞Êñá‰ª∂ËæìÂÖ•Ê°Ü');
            } else {
                console.log('Êñá‰ª∂ËæìÂÖ•Ê°ÜÊâæÂà∞');
            }
            
            // ‰ªélocalStorageÂä†ËΩΩ‰øùÂ≠òÁöÑAPIÈÖçÁΩÆ
            const savedClaudeKey = localStorage.getItem('claudeApiKey');
            const savedGptKey = localStorage.getItem('gptApiKey');
            const savedGptBaseUrl = localStorage.getItem('gptBaseUrl');
            
            if (savedClaudeKey) {
                document.getElementById('claudeApiKey').value = savedClaudeKey;
            }
            if (savedGptKey) {
                document.getElementById('gptApiKey').value = savedGptKey;
            }
            if (savedGptBaseUrl) {
                document.getElementById('gptBaseUrl').value = savedGptBaseUrl;
            }

            // ‰øùÂ≠òAPIÈÖçÁΩÆÂà∞localStorage
            ['claudeApiKey', 'gptApiKey', 'gptBaseUrl'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('blur', function() {
                        localStorage.setItem(id, this.value);
                        console.log('‰øùÂ≠òÈÖçÁΩÆ:', id, this.value ? '***Â∑≤ËÆæÁΩÆ***' : 'Êú™ËÆæÁΩÆ');
                    });
                }
            });

            // Ê∑ªÂä†Âø´Êç∑ÈîÆÊîØÊåÅ
            document.addEventListener('keydown', function(e) {
                // Ctrl+Enter ÂºÄÂßãÁøªËØë
                if (e.ctrlKey && e.key === 'Enter') {
                    console.log('Âø´Êç∑ÈîÆËß¶ÂèëÁøªËØë');
                    document.getElementById('startTranslation').click();
                }
                // Ctrl+D ‰∏ãËΩΩÁªìÊûú
                if (e.ctrlKey && e.key.toLowerCase() === 'd') {
                    e.preventDefault();
                    if (translator.results.length > 0) {
                        document.getElementById('downloadZip').click();
                    }
                }
            });

            // Ê∑ªÂä†ÂÖ®ÈÄâÂäüËÉΩ
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key.toLowerCase() === 'a' && e.target.classList.contains('content-text')) {
                    e.preventDefault();
                    const selection = window.getSelection();
                    const range = document.createRange();
                    range.selectNodeContents(e.target);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            });
        });

        // Ê∑ªÂä†È¢ùÂ§ñÁöÑÂ∑•ÂÖ∑ÂáΩÊï∞
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function estimateTranslationTime(fileCount, avgFileSize) {
            // Á≤óÁï•‰º∞ÁÆóÁøªËØëÊó∂Èó¥ÔºàÁßíÔºâ
            const timePerKB = 2; // ÊØèKBÂ§ßÁ∫¶ÈúÄË¶Å2Áßí
            const avgSizeKB = avgFileSize / 1024;
            return Math.ceil(fileCount * avgSizeKB * timePerKB);
        }

        // Ê∑ªÂä†ÊâπÈáèÊìç‰ΩúÊîØÊåÅ
        function addBatchOperations() {
            const resultsSection = document.getElementById('resultsSection');
            if (!resultsSection.querySelector('.batch-operations')) {
                const batchDiv = document.createElement('div');
                batchDiv.className = 'batch-operations';
                batchDiv.style.cssText = 'margin: 20px 0; padding: 15px; background: #f8f9ff; border-radius: 8px;';
                batchDiv.innerHTML = `
                    <h4 style="margin-bottom: 10px; color: #667eea;">ÊâπÈáèÊìç‰Ωú</h4>
                    <button class="copy-btn" onclick="copyAllTranslations()" style="margin-right: 10px;">Â§çÂà∂ÊâÄÊúâËØëÊñá</button>
                    <button class="copy-btn" onclick="copyAsMarkdown()" style="background: #6f42c1;">ÂØºÂá∫‰∏∫Markdown</button>
                `;
                resultsSection.insertBefore(batchDiv, document.getElementById('translationResults'));
            }
        }

        function copyAllTranslations() {
            if (translator.results.length === 0) return;
            
            const allTranslations = translator.results.map(result => 
                `=== ${result.filename} ===\n${result.translated}\n`
            ).join('\n');
            
            navigator.clipboard.writeText(allTranslations).then(() => {
                translator.showStatus('Â∑≤Â§çÂà∂ÊâÄÊúâËØëÊñáÂà∞Ââ™Ë¥¥Êùø', 'success');
            }).catch(() => {
                // Â§áÁî®ÊñπÊ°à
                const textArea = document.createElement('textarea');
                textArea.value = allTranslations;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                translator.showStatus('Â∑≤Â§çÂà∂ÊâÄÊúâËØëÊñáÂà∞Ââ™Ë¥¥Êùø', 'success');
            });
        }

        function copyAsMarkdown() {
            if (translator.results.length === 0) return;
            
            let markdown = '# ÊâπÈáèÁøªËØëÁªìÊûú\n\n';
            markdown += `**ÁøªËØëÊó∂Èó¥**: ${new Date().toLocaleString()}\n`;
            markdown += `**Êñá‰ª∂Êï∞Èáè**: ${translator.results.length}\n\n`;
            
            translator.results.forEach((result, index) => {
                markdown += `## ${index + 1}. ${result.filename}\n\n`;
                markdown += '### ÂéüÊñá\n```\n' + result.original + '\n```\n\n';
                markdown += '### ËØëÊñá\n```\n' + result.translated + '\n```\n\n';
                markdown += '---\n\n';
            });
            
            navigator.clipboard.writeText(markdown).then(() => {
                translator.showStatus('Â∑≤Â§çÂà∂MarkdownÊ†ºÂºèÂà∞Ââ™Ë¥¥Êùø', 'success');
            });
        }

        // Êâ©Â±ïBatchTranslatorÁ±ªÁöÑÊñπÊ≥ï
        BatchTranslator.prototype.displayResults = function() {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContainer = document.getElementById('translationResults');
            
            resultsSection.style.display = 'block';
            resultsContainer.innerHTML = '';

            // Ê∑ªÂä†ÊâπÈáèÊìç‰ΩúÊåâÈíÆ
            addBatchOperations();

            this.results.forEach((result, index) => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'file-result';
                
                // ËÆ°ÁÆóÁøªËØëÁªüËÆ°‰ø°ÊÅØ
                const originalLength = result.original.length;
                const translatedLength = result.translated.length;
                const compressionRatio = ((translatedLength / originalLength) * 100).toFixed(1);
                
                resultDiv.innerHTML = `
                    <h3>
                        <span>${result.filename}</span>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <small style="color: #666; font-weight: normal;">
                                ÂéüÊñá: ${originalLength}Â≠ó ‚Üí ËØëÊñá: ${translatedLength}Â≠ó (${compressionRatio}%)
                            </small>
                            <button class="copy-btn" onclick="translator.copyToClipboard(${index})" title="Â§çÂà∂ËØëÊñá (Ctrl+C)">
                                üìã Â§çÂà∂ËØëÊñá
                            </button>
                            <button class="copy-btn" onclick="translator.downloadSingle(${index})" 
                                    style="background: #17a2b8;" title="ÂçïÁã¨‰∏ãËΩΩÊ≠§Êñá‰ª∂">
                                üíæ ‰∏ãËΩΩ
                            </button>
                        </div>
                    </h3>
                    <div class="translation-content">
                        <div class="content-block">
                            <h4>ÂéüÊñá (${originalLength} Â≠óÁ¨¶)</h4>
                            <div class="content-text" tabindex="0">${this.escapeHtml(result.original)}</div>
                        </div>
                        <div class="content-block">
                            <h4>ËØëÊñá (${translatedLength} Â≠óÁ¨¶)</h4>
                            <div class="content-text" tabindex="0">${this.escapeHtml(result.translated)}</div>
                        </div>
                    </div>
                `;
                resultsContainer.appendChild(resultDiv);
            });
        };

        // Ê∑ªÂä†ÂçïÊñá‰ª∂‰∏ãËΩΩÂäüËÉΩ
        BatchTranslator.prototype.downloadSingle = function(index) {
            const result = this.results[index];
            const blob = new Blob([result.translated], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = result.filename.replace('.txt', '_translated.txt');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            this.showStatus(`${result.filename} ‰∏ãËΩΩÂÆåÊàê`, 'success');
        };

        // HTMLËΩ¨‰πâÂáΩÊï∞
        BatchTranslator.prototype.escapeHtml = function(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };

        // Ê∑ªÂä†ÁøªËØëË¥®ÈáèÊ£ÄÊü•
        BatchTranslator.prototype.checkTranslationQuality = function(original, translated) {
            const issues = [];
            
            
            // Ê£ÄÊü•ÈïøÂ∫¶ÊØî‰æãÊòØÂê¶ÂêàÁêÜ
            const lengthRatio = translated.length / original.length;
            if (lengthRatio < 0.3 || lengthRatio > 3) {
                issues.push('ËØëÊñáÈïøÂ∫¶ÂºÇÂ∏∏');
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ÈîôËØØ‰ø°ÊÅØ
            if (translated.includes('error') || translated.includes('Error') || translated.includes('Â§±Ë¥•')) {
                issues.push('ËØëÊñáÂèØËÉΩÂåÖÂê´ÈîôËØØ‰ø°ÊÅØ');
            }
            
            return issues;
        };

        // È°µÈù¢ÊèêÁ§∫‰ø°ÊÅØ
        console.log('üåê ÊâπÈáèÁøªËØëÂ∑•ÂÖ∑Â∑≤Âä†ËΩΩÂÆåÊàêÔºÅ');
        console.log('üí° Âø´Êç∑ÈîÆ: Ctrl+Enter ÂºÄÂßãÁøªËØë, Ctrl+D ‰∏ãËΩΩÁªìÊûú');
        console.log('üìö ÊîØÊåÅÊãñÊãΩ‰∏ä‰º†„ÄÅExcelÂØπÁÖßË°®ÁøªËØë„ÄÅÊâπÈáè‰∏ãËΩΩÁ≠âÂäüËÉΩ');
    </script>
</body>
</html>