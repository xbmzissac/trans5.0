<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡ç¿»è¯‘å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #667eea;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
        }

        .section h2::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            margin-right: 10px;
        }

        .file-upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            margin-bottom: 15px;
        }

        .file-upload-area:hover {
            border-color: #764ba2;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            transform: translateY(-2px);
        }

        .file-upload-area.dragover {
            border-color: #764ba2;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
        }

        input[type="file"] {
            display: none;
        }

        .upload-label {
            cursor: pointer;
            display: inline-block;
            padding: 12px 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 25px;
            transition: all 0.3s ease;
            font-weight: 600;
            margin: 10px;
        }

        .upload-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .api-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .api-group {
            padding: 20px;
            background: #f8f9ff;
            border-radius: 12px;
            border: 2px solid #e0e6ff;
        }

        .api-group h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }

        input[type="text"], input[type="url"], select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e6ff;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        input[type="text"]:focus, input[type="url"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .translate-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .translate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }

        .translate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e6ff;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .results {
            margin-top: 30px;
        }

        .file-result {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #667eea;
        }

        .file-result h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .translation-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .content-block {
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        .content-block h4 {
            margin-bottom: 10px;
            color: #495057;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .content-text {
            white-space: pre-wrap;
            line-height: 1.6;
            color: #333;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
        }

        .download-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .status {
            padding: 10px 20px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .file-list {
            background: #f8f9ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e0e6ff;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            .api-config {
                grid-template-columns: 1fr;
            }
            
            .translation-content {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ æ‰¹é‡ç¿»è¯‘å·¥å…·</h1>
        
        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="section">
            <h2>ğŸ“ æ–‡ä»¶ä¸Šä¼ </h2>
            
            <div class="file-upload-area" id="txtUploadArea">
                <p>æ‹–æ‹½TXTæ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©</p>
                <label for="txtFiles" class="upload-label">é€‰æ‹©TXTæ–‡ä»¶</label>
                <input type="file" id="txtFiles" multiple accept=".txt" />
            </div>
            <div id="txtFileList" class="file-list" style="display: none;"></div>
            
            <div class="file-upload-area" id="excelUploadArea">
                <p>ä¸Šä¼ Excelå¯¹ç…§è¡¨ï¼ˆåŒ…å«åŸæ–‡å’Œè¯‘æ–‡åˆ—ï¼‰</p>
                <label for="excelFile" class="upload-label">é€‰æ‹©Excelæ–‡ä»¶</label>
                <input type="file" id="excelFile" accept=".xlsx,.xls" />
            </div>
            <div id="excelFileInfo" class="file-list" style="display: none;"></div>
        </div>

        <!-- APIé…ç½® -->
        <div class="section">
            <h2>ğŸ”§ APIé…ç½®</h2>
            <div class="api-config">
                <div class="api-group">
                    <h3>Claude API</h3>
                    <div class="form-group">
                        <label for="claudeApiKey">APIå¯†é’¥</label>
                        <input type="text" id="claudeApiKey" placeholder="sk-ant-..." />
                    </div>
                    <div class="form-group">
                        <label for="claudeModel">æ¨¡å‹</label>
                        <select id="claudeModel">
                            <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                            <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                            <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                        </select>
                    </div>
                </div>
                
                <div class="api-group">
                    <h3>GPT API</h3>
                    <div class="form-group">
                        <label for="gptApiKey">APIå¯†é’¥</label>
                        <input type="text" id="gptApiKey" placeholder="sk-..." />
                    </div>
                    <div class="form-group">
                        <label for="gptModel">æ¨¡å‹</label>
                        <select id="gptModel">
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-4-turbo-preview">GPT-4 Turbo</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gptBaseUrl">Base URL (å¯é€‰)</label>
                        <input type="url" id="gptBaseUrl" placeholder="https://api.openai.com/v1" />
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="translateEngine">ç¿»è¯‘å¼•æ“</label>
                <select id="translateEngine">
                    <option value="claude">Claude</option>
                    <option value="gpt">GPT</option>
	    <option value="both">Claude + GPT åŒå¼•æ“</option>
                </select>
            </div>
        </div>

        <!-- ç¿»è¯‘æ§åˆ¶ -->
        <div class="section">
            <h2>ğŸš€ å¼€å§‹ç¿»è¯‘</h2>
            <button class="translate-btn" id="startTranslation">å¼€å§‹æ‰¹é‡ç¿»è¯‘</button>
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="statusMsg"></div>
        </div>

        <!-- ç¿»è¯‘ç»“æœ -->
        <div class="section results" id="resultsSection" style="display: none;">
            <h2>ğŸ“‹ ç¿»è¯‘ç»“æœ</h2>
            <button class="download-btn" id="downloadZip">ä¸‹è½½ZIPæ–‡ä»¶</button>
            <div id="translationResults"></div>
        </div>
    </div>

    <script>
        class BatchTranslator {
            constructor() {
                this.txtFiles = [];
                this.excelData = null;
                this.translationDict = {};
                this.results = [];
                this.initEventListeners();
            }

            initEventListeners() {
                // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
                document.getElementById('txtFiles').addEventListener('change', (e) => {
                    this.handleTxtFiles(e.target.files);
                });

                document.getElementById('excelFile').addEventListener('change', (e) => {
                    this.handleExcelFile(e.target.files[0]);
                });

                // æ‹–æ‹½äº‹ä»¶
                const txtArea = document.getElementById('txtUploadArea');
                txtArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    txtArea.classList.add('dragover');
                });

                txtArea.addEventListener('dragleave', () => {
                    txtArea.classList.remove('dragover');
                });

                txtArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    txtArea.classList.remove('dragover');
                    this.handleTxtFiles(e.dataTransfer.files);
                });

                // ç¿»è¯‘æŒ‰é’®
                document.getElementById('startTranslation').addEventListener('click', () => {
                    this.startTranslation();
                });

                // ä¸‹è½½æŒ‰é’®
                document.getElementById('downloadZip').addEventListener('click', () => {
                    this.downloadResults();
                });
            }

            handleTxtFiles(files) {
                this.txtFiles = Array.from(files).filter(file => file.type === 'text/plain' || file.name.endsWith('.txt'));
                this.displayTxtFiles();
            }

            displayTxtFiles() {
                const fileList = document.getElementById('txtFileList');
                if (this.txtFiles.length === 0) {
                    fileList.style.display = 'none';
                    return;
                }

                fileList.style.display = 'block';
                fileList.innerHTML = '<h4>å·²é€‰æ‹©çš„TXTæ–‡ä»¶ï¼š</h4>';
                this.txtFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <span>${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                        <button onclick="translator.removeTxtFile(${index})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">åˆ é™¤</button>
                    `;
                    fileList.appendChild(fileItem);
                });
            }

            removeTxtFile(index) {
                this.txtFiles.splice(index, 1);
                this.displayTxtFiles();
            }

            async handleExcelFile(file) {
                if (!file) return;

                try {
                    const data = await this.readFile(file);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    this.excelData = jsonData;
                    this.buildTranslationDict();
                    this.displayExcelInfo(file.name, jsonData.length);
                } catch (error) {
                    this.showStatus('Excelæ–‡ä»¶è¯»å–å¤±è´¥: ' + error.message, 'error');
                }
            }

            buildTranslationDict() {
                this.translationDict = {};
                if (!this.excelData) return;

                // è‡ªåŠ¨æ£€æµ‹åˆ—å
                const firstRow = this.excelData[0];
                const columns = Object.keys(firstRow);
                
                // å¯»æ‰¾å¯èƒ½çš„åŸæ–‡å’Œè¯‘æ–‡åˆ—
                let sourceCol = null, targetCol = null;
                
                for (let col of columns) {
                    const lowerCol = col.toLowerCase();
                    if (lowerCol.includes('åŸæ–‡') || lowerCol.includes('source') || lowerCol.includes('original')) {
                        sourceCol = col;
                    }
                    if (lowerCol.includes('è¯‘æ–‡') || lowerCol.includes('target') || lowerCol.includes('translation')) {
                        targetCol = col;
                    }
                }

                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œä½¿ç”¨å‰ä¸¤åˆ—
                if (!sourceCol || !targetCol) {
                    sourceCol = columns[0];
                    targetCol = columns[1];
                }

                // æ„å»ºç¿»è¯‘å­—å…¸
                this.excelData.forEach(row => {
                    const source = row[sourceCol];
                    const target = row[targetCol];
                    if (source && target) {
                        this.translationDict[source.trim()] = target.trim();
                    }
                });

                this.showStatus(`å·²åŠ è½½${Object.keys(this.translationDict).length}æ¡ç¿»è¯‘å¯¹ç…§`, 'success');
            }

            displayExcelInfo(filename, rowCount) {
                const excelInfo = document.getElementById('excelFileInfo');
                excelInfo.style.display = 'block';
                excelInfo.innerHTML = `
                    <h4>Excelæ–‡ä»¶ä¿¡æ¯ï¼š</h4>
                    <div class="file-item">
                        <span>${filename}</span>
                        <span>${rowCount}è¡Œæ•°æ®</span>
                    </div>
                `;
            }

            async readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(new Uint8Array(e.target.result));
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }

            async readTextFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsText(file, 'utf-8');
                });
            }

            async startTranslation() {
                if (this.txtFiles.length === 0) {
                    this.showStatus('è¯·å…ˆé€‰æ‹©TXTæ–‡ä»¶', 'error');
                    return;
                }

                // æ›¿æ¢åŸæ¥çš„APIå¯†é’¥éªŒè¯éƒ¨åˆ†
	const engine = document.getElementById('translateEngine').value;
	let apiKeyValid = false;

	if (engine === 'claude') {
    	    apiKeyValid = document.getElementById('claudeApiKey').value.trim() !== '';
	} else if (engine === 'gpt') {
    	    apiKeyValid = document.getElementById('gptApiKey').value.trim() !== '';
	} else if (engine === 'both') {
	    const claudeKey = document.getElementById('claudeApiKey').value.trim();
	    const gptKey = document.getElementById('gptApiKey').value.trim();
	    apiKeyValid = claudeKey !== '' && gptKey !== '';
	}

	if (!apiKeyValid) {
	    this.showStatus('è¯·è¾“å…¥ç›¸åº”çš„APIå¯†é’¥', 'error');
	    return;
	}

                this.showProgress(true);
                this.results = [];
                
                for (let i = 0; i < this.txtFiles.length; i++) {
                    const file = this.txtFiles[i];
                    this.updateProgress((i / this.txtFiles.length) * 100, `æ­£åœ¨ç¿»è¯‘: ${file.name}`);
                    
                    try {
                        const content = await this.readTextFile(file);
                        const translatedContent = await this.translateText(content, engine);
                        
                        this.results.push({
                            filename: file.name,
                            original: content,
                            translated: translatedContent
                        });
                        
                        this.showStatus(`âœ… ${file.name} ç¿»è¯‘å®Œæˆ`, 'success');
                    } catch (error) {
                        this.showStatus(`âŒ ${file.name} ç¿»è¯‘å¤±è´¥: ${error.message}`, 'error');
                        this.results.push({
                            filename: file.name,
                            original: await this.readTextFile(file),
                            translated: 'ç¿»è¯‘å¤±è´¥: ' + error.message
                        });
                    }
                }

                this.updateProgress(100, 'ç¿»è¯‘å®Œæˆï¼');
                this.displayResults();
                this.showProgress(false);
            }

            async translateText(text, engine) {
	let translatedText;
    
    	// æ ¹æ®å¼•æ“é€‰æ‹©è¿›è¡Œç¿»è¯‘
    	if (engine === 'claude') {
	        translatedText = await this.translateWithClaude(text);
	} else if (engine === 'gpt') {
	        translatedText = await this.translateWithGPT(text);
	} else if (engine === 'both') {
        	// åŒAPIåŒæ—¶ç¿»è¯‘
	        const [claudeResult, gptResult] = await Promise.allSettled([
	            this.translateWithClaude(text),
	            this.translateWithGPT(text)
	        ]);
        
	        // å¤„ç†ç¿»è¯‘ç»“æœ
	        let claudeTranslation = '';
	        let gptTranslation = '';
        
	        if (claudeResult.status === 'fulfilled') {
	            claudeTranslation = claudeResult.value;
	        } else {
	            claudeTranslation = `Claudeç¿»è¯‘å¤±è´¥: ${claudeResult.reason.message}`;
	        }
        
	        if (gptResult.status === 'fulfilled') {
	            gptTranslation = gptResult.value;
	        } else {
	            gptTranslation = `GPTç¿»è¯‘å¤±è´¥: ${gptResult.reason.message}`;
	        }
        
	        // åˆå¹¶ä¸¤ä¸ªç¿»è¯‘ç»“æœ
	        translatedText = `=== Claudeç¿»è¯‘ ===\n${claudeTranslation}\n\n=== GPTç¿»è¯‘ ===\n${gptTranslation}`;
	    } else {
	        throw new Error('æœªçŸ¥çš„ç¿»è¯‘å¼•æ“');
	    }
    
	    // ç„¶ååœ¨APIç¿»è¯‘ç»“æœåŸºç¡€ä¸Šåº”ç”¨Excelå¯¹ç…§è¡¨è¿›è¡Œåå¤„ç†
	    if (Object.keys(this.translationDict).length > 0) {
	        translatedText = this.applyDictionaryTranslation(translatedText);
	    }
    
	    return translatedText;
            }

// åŒæ—¶éœ€è¦æ›´æ–°HTMLä¸­çš„ç¿»è¯‘å¼•æ“é€‰æ‹©å™¨
// åœ¨HTMLçš„selecté€‰é¡¹ä¸­æ·»åŠ ï¼š
// <option value="both">Claude + GPT åŒå¼•æ“</option>

                // å¦åˆ™ä½¿ç”¨APIç¿»è¯‘
                if (engine === 'claude') {
                    return await this.translateWithClaude(text);
                } else {
                    return await this.translateWithGPT(text);
                }
            }

            applyDictionaryTranslation(text) {
                if (Object.keys(this.translationDict).length === 0) {
                    return text;
                }

                let translatedText = text;
                
                // æŒ‰é•¿åº¦æ’åºï¼Œä¼˜å…ˆæ›¿æ¢é•¿çŸ­è¯­
                const sortedKeys = Object.keys(this.translationDict).sort((a, b) => b.length - a.length);
                
                for (let source of sortedKeys) {
                    const target = this.translationDict[source];
                    // ä½¿ç”¨å…¨å±€æ›¿æ¢
                    translatedText = translatedText.split(source).join(target);
                }

                return translatedText;
            }

            async translateWithClaude(text) {
                const apiKey = document.getElementById('claudeApiKey').value;
                const model = document.getElementById('claudeModel').value;

                const prompt = this.buildTranslationPrompt(text);

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: model,
                        max_tokens: 4000,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Claude APIé”™è¯¯: ${response.status}`);
                }

                const data = await response.json();
                return data.content[0].text;
            }

            async translateWithGPT(text) {
                const apiKey = document.getElementById('gptApiKey').value;
                const model = document.getElementById('gptModel').value;
                const baseUrl = document.getElementById('gptBaseUrl').value || 'https://api.openai.com/v1';

                const prompt = this.buildTranslationPrompt(text);

                const response = await fetch(`${baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }],
                        max_tokens: 4000,
                        temperature: 0.3
                    })
                });

                if (!response.ok) {
                    throw new Error(`GPT APIé”™è¯¯: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            }

            buildTranslationPrompt(text) {
                let prompt = "ä½ æ˜¯ä¸€ä¸ªä¸­é˜¿çŸ­å¥å­—å¹•ç¿»è¯‘ï¼Œè¯·ç”¨æ ‡å‡†åœ°é“çš„é˜¿æ‹‰ä¼¯è¯­æ ‡å‡†è¯­å°†ä¸‹é¢çš„ä¸­æ–‡å°è¯ç¿»è¯‘ä¸ºé˜¿æ‹‰ä¼¯è¯­ï¼Œç¡®ä¿ä¹‹åçš„ç¿»è¯‘éƒ½éµä»ä»¥ä¸‹ç¿»è¯‘åŸåˆ™ï¼š1.è¯­æ³•å‡†ç¡®ï¼Œä¸å¾—éšæ„å¢åŠ æˆ–åˆ å‡åŸæ–‡ï¼Œä¸å¾—å½±å“æ•…äº‹å‰§æƒ…å‘å±•ï¼Œè¦åšåˆ°ä¿¡è¾¾é›…ï¼šä¿¡ï¼šè§„èŒƒç”¨è¯ï¼Œæ­£ç¡®ç¿»è¯‘åŸæ–‡çš„æ„æ€ï¼Œä¸å¾—é”™è¯‘ã€æ¼è¯‘ã€å¢è¯‘ï¼›è¾¾ï¼šè¡¨è¾¾çš„æ„æ€è¦åˆ°ä½ï¼Œä½†æ˜¯ä¸éœ€è¦å®Œå…¨é€å­—ç¿»è¯‘ï¼›é›…ï¼šä¸ºäº†é€‚åº”å¤–å›½è¯»è€…çš„é˜…è¯»ä¹ æƒ¯ï¼Œåº”è¯¥æ ¹æ®é˜¿æ‹‰ä¼¯è¯­çš„è¡¨è¾¾ä¹ æƒ¯å’Œé€»è¾‘ï¼Œå¯¹åŸæ–‡è¿›è¡Œé€‚å½“çš„è°ƒæ•´ï¼Œä»¥ç¡®ä¿è¯‘æ–‡çš„å¯è¯»æ€§å’Œæµç•…æ€§ï¼Œ2.è¯‘æ–‡ä¸­é˜¿æ‹‰ä¼¯è¯­ä¸è¦æ·»åŠ ä»»ä½•æ ‡éŸ³ç¬¦å·ã€‚è¯·å°†è¿™æ®µè¯æ›´æ–°åˆ°æˆ‘çš„è®°å¿†é‡Œå¹¶åœ¨ä»¥åç¿»è¯‘é‡Œè¿ç”¨ã€‚3.ç”¨è¯è´´è¿‘é˜¿æ‹‰ä¼¯è¯­ç”Ÿæ´»è¯­å¢ƒï¼Œä¿—è¯­ä¿šè¯­ä¸ç›´è¯‘ï¼Œå°½é‡åœ¨é˜¿æ‹‰ä¼¯è¯­ä¸­å¯»æ‰¾å¯ä»¥è¡¨è¾¾ç›¸ä¼¼æ„æ€çš„é˜¿æ‹‰ä¼¯è¯­ä¿—è¯­æ¥æ›¿ä»£ã€‚4.åªè¾“å‡ºè¯‘æ–‡ï¼Œä¸è¦åŒ…å«ä»»ä½•è§£é‡Šæˆ–åŸæ–‡ã€‚ï¼š\n\n" + text;
                if (Object.keys(this.translationDict).length > 0) {
                    prompt += "\n\n 1. å¿…é¡»ä¼˜å…ˆä½¿ç”¨ä»¥ä¸‹æœ¯è¯­è¡¨ï¼ˆä¸å¯ä¿®æ”¹ï¼‰ï¼š\n";
                    const examples = Object.entries(this.translationDict).slice(0, 10);
                    examples.forEach(([source, target]) => {
                        prompt += `${source} -> ${target}\n`;
                    });
                    prompt += "\nè¯·ä¼˜å…ˆä½¿ç”¨ä¸Šè¿°å¯¹ç…§è¡¨ä¸­çš„ç¿»è¯‘ã€‚";
                }

                return prompt;
            }

            showProgress(show) {
                const progressBar = document.getElementById('progressBar');
                progressBar.style.display = show ? 'block' : 'none';
                
                const button = document.getElementById('startTranslation');
                button.disabled = show;
                button.textContent = show ? 'ç¿»è¯‘ä¸­...' : 'å¼€å§‹æ‰¹é‡ç¿»è¯‘';
            }

            updateProgress(percent, message) {
                const progressFill = document.getElementById('progressFill');
                progressFill.style.width = percent + '%';
                
                if (message) {
                    this.showStatus(message, 'info');
                }
            }

            showStatus(message, type) {
                const statusMsg = document.getElementById('statusMsg');
                statusMsg.innerHTML = `<div class="status ${type}">${message}</div>`;
            }

            displayResults() {
                const resultsSection = document.getElementById('resultsSection');
                const resultsContainer = document.getElementById('translationResults');
                
                resultsSection.style.display = 'block';
                resultsContainer.innerHTML = '';

                this.results.forEach((result, index) => {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'file-result';
                    resultDiv.innerHTML = `
                        <h3>
                            ${result.filename}
                            <button class="copy-btn" onclick="translator.copyToClipboard(${index})">å¤åˆ¶è¯‘æ–‡</button>
                        </h3>
                        <div class="translation-content">
                            <div class="content-block">
                                <h4>åŸæ–‡</h4>
                                <div class="content-text">${result.original}</div>
                            </div>
                            <div class="content-block">
                                <h4>è¯‘æ–‡</h4>
                                <div class="content-text">${result.translated}</div>
                            </div>
                        </div>
                    `;
                    resultsContainer.appendChild(resultDiv);
                });
            }

            async copyToClipboard(index) {
                const result = this.results[index];
                try {
                    await navigator.clipboard.writeText(result.translated);
                    this.showStatus(`å·²å¤åˆ¶ ${result.filename} çš„è¯‘æ–‡åˆ°å‰ªè´´æ¿`, 'success');
                } catch (error) {
                    // å¤‡ç”¨æ–¹æ¡ˆ
                    const textArea = document.createElement('textarea');
                    textArea.value = result.translated;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    this.showStatus(`å·²å¤åˆ¶ ${result.filename} çš„è¯‘æ–‡åˆ°å‰ªè´´æ¿`, 'success');
                }
            }

            async downloadResults() {
                if (this.results.length === 0) {
                    this.showStatus('æ²¡æœ‰ç¿»è¯‘ç»“æœå¯ä¸‹è½½', 'error');
                    return;
                }

                const zip = new JSZip();
                
                this.results.forEach(result => {
                    const filename = result.filename.replace('.txt', '_translated.txt');
                    zip.file(filename, result.translated);
                });

                const content = await zip.generateAsync({ type: 'blob' });
const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = `translation_results_${new Date().toISOString().slice(0, 10)}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showStatus('ZIPæ–‡ä»¶ä¸‹è½½å·²å¼€å§‹', 'success');
            }
        }

        // åˆå§‹åŒ–ç¿»è¯‘å™¨
        const translator = new BatchTranslator();

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–ç¿»è¯‘å™¨');
            
            // æµ‹è¯•æŒ‰é’®ç‚¹å‡»
            const translateBtn = document.getElementById('startTranslation');
            const txtFilesInput = document.getElementById('txtFiles');
            
            if (!translateBtn) {
                console.error('æ‰¾ä¸åˆ°ç¿»è¯‘æŒ‰é’®');
            } else {
                console.log('ç¿»è¯‘æŒ‰é’®æ‰¾åˆ°');
            }
            
            if (!txtFilesInput) {
                console.error('æ‰¾ä¸åˆ°æ–‡ä»¶è¾“å…¥æ¡†');
            } else {
                console.log('æ–‡ä»¶è¾“å…¥æ¡†æ‰¾åˆ°');
            }
            
            // ä»localStorageåŠ è½½ä¿å­˜çš„APIé…ç½®
            const savedClaudeKey = localStorage.getItem('claudeApiKey');
            const savedGptKey = localStorage.getItem('gptApiKey');
            const savedGptBaseUrl = localStorage.getItem('gptBaseUrl');
            
            if (savedClaudeKey) {
                document.getElementById('claudeApiKey').value = savedClaudeKey;
            }
            if (savedGptKey) {
                document.getElementById('gptApiKey').value = savedGptKey;
            }
            if (savedGptBaseUrl) {
                document.getElementById('gptBaseUrl').value = savedGptBaseUrl;
            }

            // ä¿å­˜APIé…ç½®åˆ°localStorage
            ['claudeApiKey', 'gptApiKey', 'gptBaseUrl'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('blur', function() {
                        localStorage.setItem(id, this.value);
                        console.log('ä¿å­˜é…ç½®:', id, this.value ? '***å·²è®¾ç½®***' : 'æœªè®¾ç½®');
                    });
                }
            });

            // æ·»åŠ å¿«æ·é”®æ”¯æŒ
            document.addEventListener('keydown', function(e) {
                // Ctrl+Enter å¼€å§‹ç¿»è¯‘
                if (e.ctrlKey && e.key === 'Enter') {
                    console.log('å¿«æ·é”®è§¦å‘ç¿»è¯‘');
                    document.getElementById('startTranslation').click();
                }
                // Ctrl+D ä¸‹è½½ç»“æœ
                if (e.ctrlKey && e.key.toLowerCase() === 'd') {
                    e.preventDefault();
                    if (translator.results.length > 0) {
                        document.getElementById('downloadZip').click();
                    }
                }
            });

            // æ·»åŠ å…¨é€‰åŠŸèƒ½
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key.toLowerCase() === 'a' && e.target.classList.contains('content-text')) {
                    e.preventDefault();
                    const selection = window.getSelection();
                    const range = document.createRange();
                    range.selectNodeContents(e.target);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            });
        });

        // æ·»åŠ é¢å¤–çš„å·¥å…·å‡½æ•°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function estimateTranslationTime(fileCount, avgFileSize) {
            // ç²—ç•¥ä¼°ç®—ç¿»è¯‘æ—¶é—´ï¼ˆç§’ï¼‰
            const timePerKB = 2; // æ¯KBå¤§çº¦éœ€è¦2ç§’
            const avgSizeKB = avgFileSize / 1024;
            return Math.ceil(fileCount * avgSizeKB * timePerKB);
        }

        // æ·»åŠ æ‰¹é‡æ“ä½œæ”¯æŒ
        function addBatchOperations() {
            const resultsSection = document.getElementById('resultsSection');
            if (!resultsSection.querySelector('.batch-operations')) {
                const batchDiv = document.createElement('div');
                batchDiv.className = 'batch-operations';
                batchDiv.style.cssText = 'margin: 20px 0; padding: 15px; background: #f8f9ff; border-radius: 8px;';
                batchDiv.innerHTML = `
                    <h4 style="margin-bottom: 10px; color: #667eea;">æ‰¹é‡æ“ä½œ</h4>
                    <button class="copy-btn" onclick="copyAllTranslations()" style="margin-right: 10px;">å¤åˆ¶æ‰€æœ‰è¯‘æ–‡</button>
                    <button class="copy-btn" onclick="copyAsMarkdown()" style="background: #6f42c1;">å¯¼å‡ºä¸ºMarkdown</button>
                `;
                resultsSection.insertBefore(batchDiv, document.getElementById('translationResults'));
            }
        }

        function copyAllTranslations() {
            if (translator.results.length === 0) return;
            
            const allTranslations = translator.results.map(result => 
                `=== ${result.filename} ===\n${result.translated}\n`
            ).join('\n');
            
            navigator.clipboard.writeText(allTranslations).then(() => {
                translator.showStatus('å·²å¤åˆ¶æ‰€æœ‰è¯‘æ–‡åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                // å¤‡ç”¨æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = allTranslations;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                translator.showStatus('å·²å¤åˆ¶æ‰€æœ‰è¯‘æ–‡åˆ°å‰ªè´´æ¿', 'success');
            });
        }

        function copyAsMarkdown() {
            if (translator.results.length === 0) return;
            
            let markdown = '# æ‰¹é‡ç¿»è¯‘ç»“æœ\n\n';
            markdown += `**ç¿»è¯‘æ—¶é—´**: ${new Date().toLocaleString()}\n`;
            markdown += `**æ–‡ä»¶æ•°é‡**: ${translator.results.length}\n\n`;
            
            translator.results.forEach((result, index) => {
                markdown += `## ${index + 1}. ${result.filename}\n\n`;
                markdown += '### åŸæ–‡\n```\n' + result.original + '\n```\n\n';
                markdown += '### è¯‘æ–‡\n```\n' + result.translated + '\n```\n\n';
                markdown += '---\n\n';
            });
            
            navigator.clipboard.writeText(markdown).then(() => {
                translator.showStatus('å·²å¤åˆ¶Markdownæ ¼å¼åˆ°å‰ªè´´æ¿', 'success');
            });
        }

        // æ‰©å±•BatchTranslatorç±»çš„æ–¹æ³•
        BatchTranslator.prototype.displayResults = function() {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContainer = document.getElementById('translationResults');
            
            resultsSection.style.display = 'block';
            resultsContainer.innerHTML = '';

            // æ·»åŠ æ‰¹é‡æ“ä½œæŒ‰é’®
            addBatchOperations();

            this.results.forEach((result, index) => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'file-result';
                
                // è®¡ç®—ç¿»è¯‘ç»Ÿè®¡ä¿¡æ¯
                const originalLength = result.original.length;
                const translatedLength = result.translated.length;
                const compressionRatio = ((translatedLength / originalLength) * 100).toFixed(1);
                
                resultDiv.innerHTML = `
                    <h3>
                        <span>${result.filename}</span>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <small style="color: #666; font-weight: normal;">
                                åŸæ–‡: ${originalLength}å­— â†’ è¯‘æ–‡: ${translatedLength}å­— (${compressionRatio}%)
                            </small>
                            <button class="copy-btn" onclick="translator.copyToClipboard(${index})" title="å¤åˆ¶è¯‘æ–‡ (Ctrl+C)">
                                ğŸ“‹ å¤åˆ¶è¯‘æ–‡
                            </button>
                            <button class="copy-btn" onclick="translator.downloadSingle(${index})" 
                                    style="background: #17a2b8;" title="å•ç‹¬ä¸‹è½½æ­¤æ–‡ä»¶">
                                ğŸ’¾ ä¸‹è½½
                            </button>
                        </div>
                    </h3>
                    <div class="translation-content">
                        <div class="content-block">
                            <h4>åŸæ–‡ (${originalLength} å­—ç¬¦)</h4>
                            <div class="content-text" tabindex="0">${this.escapeHtml(result.original)}</div>
                        </div>
                        <div class="content-block">
                            <h4>è¯‘æ–‡ (${translatedLength} å­—ç¬¦)</h4>
                            <div class="content-text" tabindex="0">${this.escapeHtml(result.translated)}</div>
                        </div>
                    </div>
                `;
                resultsContainer.appendChild(resultDiv);
            });
        };

        // æ·»åŠ å•æ–‡ä»¶ä¸‹è½½åŠŸèƒ½
        BatchTranslator.prototype.downloadSingle = function(index) {
            const result = this.results[index];
            const blob = new Blob([result.translated], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = result.filename.replace('.txt', '_translated.txt');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            this.showStatus(`${result.filename} ä¸‹è½½å®Œæˆ`, 'success');
        };

        // HTMLè½¬ä¹‰å‡½æ•°
        BatchTranslator.prototype.escapeHtml = function(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };

        // æ·»åŠ ç¿»è¯‘è´¨é‡æ£€æŸ¥
        BatchTranslator.prototype.checkTranslationQuality = function(original, translated) {
            const issues = [];
            
            
            // æ£€æŸ¥é•¿åº¦æ¯”ä¾‹æ˜¯å¦åˆç†
            const lengthRatio = translated.length / original.length;
            if (lengthRatio < 0.3 || lengthRatio > 3) {
                issues.push('è¯‘æ–‡é•¿åº¦å¼‚å¸¸');
            }
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«é”™è¯¯ä¿¡æ¯
            if (translated.includes('error') || translated.includes('Error') || translated.includes('å¤±è´¥')) {
                issues.push('è¯‘æ–‡å¯èƒ½åŒ…å«é”™è¯¯ä¿¡æ¯');
            }
            
            return issues;
        };

        // é¡µé¢æç¤ºä¿¡æ¯
        console.log('ğŸŒ æ‰¹é‡ç¿»è¯‘å·¥å…·å·²åŠ è½½å®Œæˆï¼');
        console.log('ğŸ’¡ å¿«æ·é”®: Ctrl+Enter å¼€å§‹ç¿»è¯‘, Ctrl+D ä¸‹è½½ç»“æœ');
        console.log('ğŸ“š æ”¯æŒæ‹–æ‹½ä¸Šä¼ ã€Excelå¯¹ç…§è¡¨ç¿»è¯‘ã€æ‰¹é‡ä¸‹è½½ç­‰åŠŸèƒ½');
    </script>
</body>
</html>